---
tags: [Coding]
title: JNI tutorial
created: '2021-06-17T03:16:37.370Z'
modified: '2021-06-17T06:44:05.015Z'
---

# JNI tutorial
## Create the Java Class
> ApplyWeights.java
```
public class ApplyWeights {

    static {
        System.loadLibrary("applyWeights");
    }
    
    public static void main(String[] args) {

        float weights[] = new float[8];

        weights[0] = 10f;
        weights[4] = 6f;
        
        new ApplyWeights().applyWeights(weights);
    }

    // Declare a native method sayHello() that receives no arguments and returns void
    private native void applyWeights(float[] weights);
}
```
## Create C++ definition
```
javac -h . ApplyWeights.java
```
It will auto generate `ApplyWeights.class` and `ApplyWeights.h`

> ApplyWeights.h
```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class ApplyWeights */

#ifndef _Included_ApplyWeights
#define _Included_ApplyWeights
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     ApplyWeights
 * Method:    applyWeights
 * Signature: ([F)V
 */
JNIEXPORT void JNICALL Java_ApplyWeights_applyWeights
  (JNIEnv *, jobject, jfloatArray);

#ifdef __cplusplus
}
#endif
#endif
```
Fill in the argument name and finish the cpp counterpart
```
JNIEXPORT void JNICALL Java_ApplyWeights_applyWeights
  (JNIEnv* env, jobject, jfloatArray weights_);
```

```
#include "ApplyWeights.h"
#include <ostream>
#include <iostream>

void applyWeightsNested(float const* weights, size_t count) noexcept {
  std::cout << "Weight 0: " << weights[0] << std::endl;
  std::cout << "Weight 4: " << weights[4] << std::endl;
}

void applyWeights(float const* weights, size_t count) noexcept {
  applyWeightsNested(weights, count);
}

JNIEXPORT void JNICALL Java_ApplyWeights_applyWeights
  (JNIEnv* env, jobject, jfloatArray weights_) {
    std::cout << "Initializing..." << std::endl;
    jfloat* weights = env->GetFloatArrayElements(weights_, NULL);
    jsize size = env->GetArrayLength(weights_);
    applyWeights(weights, size);
    env->ReleaseFloatArrayElements(weights_, weights, 0);
}
```
## Compiling and linking
Compile with JNI headers using `g++`
```
g++ -c -fPIC -I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux ApplyWeights.cpp -o ApplyWeights.o
```
It will generate `ApplyWeights.o`. Then link it into bridge library

```
g++ -shared -fPIC -o libapplyWeights.so ApplyWeights.o -lc
```
It will generate `libapplyWeights.so`. The last is run the program with full path of library directory
```
java -cp . -Djava.library.path=/home/ruichenzheng/jni_test ApplyWeights
```
Command line output:
```
Initializing...
Weight 0: 10
Weight 4: 6
```


